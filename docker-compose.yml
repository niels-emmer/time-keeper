services:

  # Frontend: React SPA served by nginx, proxies /api/* to backend
  # Auth is handled upstream by Authentik's proxy outpost via NPM forward auth.
  # Authentik sets X-Forwarded-Email on authenticated requests; nginx passes it to the backend.
  frontend:
    build:
      context: .
      dockerfile: packages/frontend/Dockerfile
    restart: unless-stopped
    ports:
      - "127.0.0.1:38521:80"  # Only bind to localhost â€” NPM proxies to this port
    networks:
      - app
    depends_on:
      backend:
        condition: service_healthy

  # Backend: Express API with SQLite
  backend:
    build:
      context: .
      dockerfile: packages/backend/Dockerfile
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: "3001"
      DATABASE_PATH: "/data/time-keeper.db"
    volumes:
      - db-data:/data
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - app

volumes:
  db-data:
    driver: local

networks:
  app:
    driver: bridge
